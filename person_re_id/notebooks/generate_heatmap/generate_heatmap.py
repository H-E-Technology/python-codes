# -*- coding: utf-8 -*-
"""generate_heatmap.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1AW7EHHDZXSn4ZUTcaOc91J_C7YvCiJeo
"""

from google.colab import userdata

!pip install ultralytics > /dev/null

"""### google drive ã‚’ãƒã‚¦ãƒ³ãƒˆ"""

from google.colab import drive
drive.mount('/content/drive')

"""## settings for google colab"""

# ä»»æ„ã®ãƒ‘ã‚¹
save_base_path = '/content/drive/MyDrive/HETech/output/heatmap/'

import os
os.environ['GITHUB_USERNAME'] = "shayaf"
# NOTE: GitHub Token ã¯ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã›ãšã€å¤–éƒ¨ã‹ã‚‰æ¸¡ã—ã¦ãã ã•ã„... Colabã® secret ãªã©
os.environ['GITHUB_TOKEN'] = userdata.get('github_accesstoken')

repo_url = f"https://{os.environ['GITHUB_USERNAME']}:{os.environ['GITHUB_TOKEN']}@github.com/H-E-Technology/python-codes.git"

"""## git clone"""

!git clone $repo_url

"""## execution"""

# Commented out IPython magic to ensure Python compatibility.
# %cd python-codes/person_re_id/

!pwd

!cp bytetrack.yaml /usr/local/lib/python*/dist-packages/ultralytics/cfg/trackers/
!cp botsort.yaml /usr/local/lib/python*/dist-packages/ultralytics/cfg/trackers/

# é®è”½æ™‚ä»¥å¤–ã® re-id ã‚’æ¸›ã‚‰ã™å‡¦ç†ã‚’è¿½åŠ ã—ã¦ã„ã‚‹
!cp bot_sort.py /usr/local/lib/python*/dist-packages/ultralytics/trackers/bot_sort.py

"""### å®Ÿè¡Œå‰ã®æ³¨æ„
- é•·ã„å‹•ç”»ã¯ fps ã‚’ä¸‹ã’ã¦ã‚‚å•é¡Œãªã„å ´åˆãŒå¤šã„ -> ä¸‹ã® fps ä¸‹ã’ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ´»ç”¨ã€‚

- /content/python-codes/person_re_id/config.yaml ã®ç¢ºèª
    - l.60 fpsè¨­å®šã‚’å…¥åŠ›å‹•ç”»ã¨åŒã˜ fps ã«ã™ã‚‹
"""

# model ã¯ google drive ã‹ã‚‰å–å¾—ã™ã‚‹
!python yolo_multi_model_refactored.py \
  --source "/content/2025-10-21_10-26-35_5fps.mp4" \
  --track \
  --model "/content/finetuning_okinawa.pt" \
  --dataset-yaml "adult_child.yaml" \
  --classes "0,1"

# outputã‚’zipåŒ–
!zip -r /content/output_all.zip /content/python-codes/person_re_id/output

# Driveã«ç§»å‹•
!mv /content/output_all.zip $save_base_path

"""## å‹•ç”»ã® fps ã‚’ä¸‹ã’ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆğŸ´"""

import cv2

input_path = "/content/2025-10-21_10-26-35.mp4"
output_path = "/content/2025-10-21_10-26-35_5fps.mp4"

# èª­ã¿è¾¼ã¿
cap = cv2.VideoCapture(input_path)
fps_in = cap.get(cv2.CAP_PROP_FPS)
frame_count = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
w = int(cap.get(cv2.CAP_PROP_FRAME_WIDTH))
h = int(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))

# å‡ºåŠ›fps
fps_out = 5

# VideoWriter
fourcc = cv2.VideoWriter_fourcc(*'mp4v')
out = cv2.VideoWriter(output_path, fourcc, fps_out, (w, h))

# é–“å¼•ãè¨ˆç®—
skip = int(round(fps_in / fps_out))
frame_idx = 0

while True:
    ret, frame = cap.read()
    if not ret:
        break

    # fps_out ã«åˆã‚ã›ã¦æ›¸ãå‡ºã—
    if frame_idx % skip == 0:
        out.write(frame)

    frame_idx += 1

cap.release()
out.release()

print(f"âœ… Done! {input_path} ã‚’ {fps_out}fps ã«å¤‰æ›ã—ã¾ã—ãŸ: {output_path}")

